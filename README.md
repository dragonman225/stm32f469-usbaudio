# STM32F469I-DISCO USB Audio Example

[![Actions Status](https://github.com/dragonman225/stm32f469-usbaudio/workflows/ARM Cross-compilation CI/badge.svg)](https://github.com/dragonman225/stm32f469-usbaudio/actions)

This is a port of [STM32469I-Discovery "AUDIO_Standalone" Example](https://github.com/STMicroelectronics/STM32CubeF4/tree/master/Projects/STM32469I-Discovery/Applications/USB_Device/AUDIO_Standalone) to Makefile project.

The original source only provides project config for EWARM, MDK-ARM, and SW4STM32, I ported it to Makefile so that I don't need specific IDEs to compile the code.

* Folder structure, startup script, linker file are generated by setting up a dummy project (USB, SAI, DMA, I2C, GPIO enabled) with [STM32CubeMX](https://www.st.com/en/development-tools/stm32cubemx.html).

* `Drivers/BSP/` and `Middlewares/ST/STM32_Audio/` are copied from [STM32CubeF4](https://github.com/STMicroelectronics/STM32CubeF4).

* `Inc/` and `Src/` generated by STM32CubeMX are replaced with those from [STM32469I-Discovery "AUDIO_Standalone" Example](https://github.com/STMicroelectronics/STM32CubeF4/tree/master/Projects/STM32469I-Discovery/Applications/USB_Device/AUDIO_Standalone).

## Usage

### Install toolchain

Arch Linux :

```bash
pacman -S arm-none-eabi-gcc
```

### Compile

```bash
make
```

### Program the board

Method 1 : Use `st-flash`

A `make` script is configured to call `st-flash` to program the board.

```bash
make flash
```

Method 2 : Use [STM32CubeProg](https://www.st.com/en/development-tools/stm32cubeprog.html).

1. Connect board to PC, open STM32CubeProg, click "Connect".

2. Go to "Erasing & Programming" Tab, click "Browse", choose the one of the compiled binaries (`.bin`, `.elf`, `.hex`) in `build/` folder.

3. Click "Start Programming".

### Use the board as a USB soundcard

1. Connect the board to PC from the CN13 **MicroUSB** port. (Not the ST-Link **MiniUSB** port). The ST-Link **MiniUSB** port should still be connected because the board is powered from this port.

2. There will be something like "USB Audio Speaker" appears on the PC. Play audio with that device and plug-in a headphone to the STM32 board to listen.
  
   On Linux, `pactl list short sinks` recognizes the soundcard as the following :

   ```
   alsa_output.usb-STMicroelectronics_STM32_AUDIO_Streaming_in_FS_Mode_<serial_number>-00.analog-stereo
   ```

### Debug program

VSCode, using [`cortex-debug`](https://github.com/Marus/cortex-debug) extension :

On Debug tab, choose "Debug (OpenOCD)" and start.

* SVD file used to display peripheral registers is taken from https://github.com/posborne/cmsis-svd/blob/master/data/STMicro/STM32F469.svd

## Notes

* Audio become distorted for several seconds every 5 ~ 6 minutes because this example doesn't use any synchronization method (`bmAttributes` of `Endpoint 1` is set to `0x01` â€” Transfer type: Isochronous, Synchronization type: undefined. Source: `Middlewares/ST/STM32_USB_Device_Library/Class/AUDIO/Src/usbd_audio.c:300`, Specification: https://www.usb.org/sites/default/files/audio10.pdf p.61)

* Implementing Asynchronous USB audio

  * `PCD_HandleTypeDef->Init->Sof_enable` (`Src/usbd_conf.c:274`) must be 1 to receive SOF interrupt.

  * Monitor asynchronous feedback status

    Change `cardX` to your soundcard.

    ```bash
    watch -n 0.1 cat /proc/asound/cardX/stream0
    ```

    Sample information :

    ```
    Dragonode Audio Venus DAC at usb-0000:00:02.0-3, full speed : USB Audio

    Playback:
      Status: Running
        Interface = 1
        Altset = 1
        Packet Size = 192
        Momentary freq = 47996 Hz (0x2f.fedc)
        Feedback Format = 10.14
      Interface 1
        Altset 1
        Format: S16_LE
        Channels: 2
        Endpoint: 1 OUT (ASYNC)
        Rates: 48000
    ```

* This project can be used as a template for future STM32F4 projects with some modifications.

  * To import a project made for other IDEs :

    Replace `Inc/` and `Src` with those from the project.

  * To start an empty project :

    *TBD*
    
  Then, update used sources (the `C_SOURCES` variable) and used headers (the `C_INCLUDES` variable) in `Makefile`.

* `.mxproject` and `f469-usbaudio-ex2.loc` may be deleted since we don't need to re-import to CubeMX anymore ?